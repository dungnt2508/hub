version: '3.8'

services:
  # ============================================
  # Backend API Service
  # ============================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bot_backend
    command: python scripts/startup.py
    volumes:
      # Mount source code phục vụ dev hot-reload
      - ./app:/app/app
      - ./core:/app/core
      - ./scripts:/app/scripts
      - ./alembic:/app/alembic
    ports:
      - "8386:8386"
    env_file:
      - .env
    environment:
      - ENVIRONMENT=dev
      - TZ=Asia/Ho_Chi_Minh
      - PYTHONPATH=/app
    networks:
      - shared_net  # LOCAL: Dùng chung network từ infra
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8386/health"]
      interval: 1h
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  # LOCAL: Dùng chung network từ infra
  shared_net:
    external: true
    name: hub_shared_net

  # PRODUCTION: Uncomment để tạo network riêng
  # bot_network:
  #   driver: bridge

# volumes:
  # Chỉ cần khi chạy production với infra riêng
  # postgres_data:
  # redis_data:
  # redis_insight_data:
  # qdrant_data:
  # pgadmin_data:
  # prometheus_data:
  # grafana_data: